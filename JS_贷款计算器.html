<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Javascript Loan Calculator</title>
    <style>
        th,
        td {
            vertical-align: top;
        }

        .output {
            font-weight: bold;
        }

        #payment {
            text-decoration: underline;
        }

        #graph {
            border: 1px solid black;
        }
    </style>
</head>

<body>

    <table>
        <tr>
            <th>Enter Loan Data: </th>
            <td></td>
            <th>Loan Balance, Cumulative Equity, and Interest Patments</th>
        </tr>
        <tr>
            <td>Amount of the loan ($):</td>
            <td>
                <input type="text" id="amount" onchange="calculate()">
            </td>
            <td rowspan=8>
                <canvas id="graph" width="400" height="250"></canvas>
            </td>
        </tr>
        <tr>
            <td>Annual interest (%):</td>
            <td>
                <input type="text" id="apr" onchange="calculate()">
            </td>
        </tr>
        <tr>
            <td>Repayment period (years):</td>
            <td>
                <input type="text" id="years" onchange="calculate()">
            </td>
        </tr>
        <tr>
            <td>Zipcode (to find lenders):</td>
            <td>
                <input type="text" id="zipcode" onchange="calculate()">
            </td>
        </tr>
        <tr>
            <th>Approximate Payments:</th>
            <td>
                <button onclick="calculate()">Calculate</button>
            </td>
        </tr>
        <tr>
            <td>Monthly payment:</td>
            <td>$
                <span class="output" id="payment"></span>
            </td>
        </tr>
        <tr>
            <td>Total payment:</td>
            <td>$
                <span class="output" id="total"></span>
            </td>
        </tr>
        <tr>
            <td>Total interest:</td>
            <td>$
                <span class="output" id="totalinterest"></span>
            </td>
        </tr>
        <tr>
            <th>Sponsors:</th>
            <td colspan=2>Apply for your loan with one of these fine lenders:</td>
            <div id="lenders"></div>
        </tr>
    </table>

    <script>
        function calculate() {
            // 文档中用于输入输出的元素
            let amount = document.getElementById("amount")
            let apr = document.getElementById("apr")
            let years = document.getElementById("years")
            let zipcode = document.getElementById("zipcode")
            let payment = document.getElementById("payment")
            let total = document.getElementById("total")
            let totalinterest = document.getElementById("totalinterest")

            let principal = parseFloat(amount.value)            // 假设所有的输入内容均合法 从 input 元素中获取输入数据
            let interest = parseFloat(apr.value) / 100 / 12         // 将百分比格式转换为小数格式 并从年利率转换为月利率
            let payments = parseFloat(years.value) * 12           // 将年度赔付转换为月度赔付

            // 计算月度赔付
            let x = Math.pow(1 + interest, payment)             // 幂运算
            let monthly = (principal * x * interest) / (x - 1)

            // isFinite -> 检测参数是否无穷大
            if (isFinite(monthly)) {

                // toFixed -> 将 number 四舍五入为指定小数位数的数字
                payment.innerHTML = monthly.toFixed(2)
                total.innerHTML = (monthly * payments).toFixed(2)
                totalinterest.innerHTML = ((monthly * payments) - principal).toFixed(2)

                // 保存输入数据 以便下次访问
                save(amount.value, apr.value, years.value, zipcode.value)

                // 找到并展示本地放贷人 忽略网络错误
                try {
                    // 捕捉这段代码抛出的所有异常
                    getLenders(amount.value, apr.value, years.value, zipcode.value)
                }
                catch (e) {/* 忽略这些异常 */ }

                chart(principal, interest, monthly, payments)       // 用图表展示贷款金额、利息、资产收益

            } else {

                // 清空元素的文本内容
                payment.innerHTML = ""
                total.innerHTML = ""
                totalinterest.innerHTML = ""
                chart()        // 无数据则清楚图表
            }
        }

        function save(amount, apr, years, zipcode) {

            // 当浏览器支持时运行此处代码
            if (window.localStorage) {

                // localStorage -> 本地存储
                localStorage.loan_amount = amount
                localStorage.loan_apr = apr
                localStorage.loan_years = years
                localStorage.loan_zipcode = zipcode
            }
        }

        // 在文档首次加载时 尝试还原输入字段
        window.onload = function () {

            // 如果浏览器支持本地存储 && 上次保存的值存在
            if (window.localStorage && localStorage.loan_amount) {
                document.getElementById("amount").value = localStorage.loan_amount
                document.getElementById("apr").value = localStorage.loan_apr
                document.getElementById("years").value = localStorage.loan_years
                document.getElementById("zipcode").value = localStorage.loan_zipcode
            }
        }


    </script>
</body>

</html>
